<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Custos - Balneário Caratinga</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .cmv-green { color: #16a34a; background-color: #dcfce7; }
        .cmv-yellow { color: #ca8a04; background-color: #fef9c3; }
        .cmv-red { color: #dc2626; background-color: #fee2e2; }
        /* Animation for logs */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .log-entry { animation: fadeIn 0.3s ease-out; }
        #root:empty::before { content: 'Carregando sistema...'; display: block; padding: 20px; text-align: center; color: #666; }
        th { cursor: pointer; user-select: none; }
        th:hover { background-color: #f3f4f6; }
    </style>

    <!-- Error Handling -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", error);
            return false;
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Configuration & Init -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose to global window object securely
        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken,
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc, 
            writeBatch, 
            getDocs 
        };

        // Dispatch event to signal Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
                ChefHat: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" x2="18" y1="17" y2="17"/></svg>,
                Calculator: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
                TrendingUp: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
                AlertTriangle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
                Save: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                Trash2: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
                Edit3: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
                MapPin: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
                Filter: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
                Loader: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
                ArrowUp: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>,
                ArrowDown: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>,
                DollarSign: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
                BarChart: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
                Clipboard: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
                Scale: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
            };
            return icons[name] || null;
        };

        const UNITS = ['Geral', 'Matriz', 'Mucambo', 'Frecheirinha', 'Tianguá'];

        // --- APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard'); 
            const [selectedUnit, setSelectedUnit] = useState('Geral'); 
            const [ingredients, setIngredients] = useState([]);
            const [dishes, setDishes] = useState([]);
            const [sales, setSales] = useState([]); // Nova coleção de vendas
            const [selectedDish, setSelectedDish] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authWarning, setAuthWarning] = useState('');
            const [errorMsg, setErrorMsg] = useState('');

            // Firebase refs
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState(null);

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        if (!window.firebaseModules) {
                            await new Promise(resolve => window.addEventListener('firebase-ready', resolve, { once: true }));
                        }

                        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore } = window.firebaseModules;
                        
                        const config = {
                            apiKey: "AIzaSyDiop3HwQsmvU6RNNQmxPUOJ2qj2zGAyCs",
                            authDomain: "custospratos.firebaseapp.com",
                            projectId: "custospratos",
                            storageBucket: "custospratos.firebasestorage.app",
                            messagingSenderId: "715914461934",
                            appId: "1:715914461934:web:db0b2fb6ee562b652a29ff",
                            measurementId: "G-GNRKTZNZXN"
                        };

                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        
                        setDb(firestore);
                        setAppId('custos-pratos-web'); 

                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.warn("Autenticação falhou:", authError);
                            setAuthWarning('Aviso: Login Anônimo não habilitado no Firebase. Usando modo local temporário.');
                            const mockUser = { uid: "local-user-" + Math.floor(Math.random() * 10000) };
                            setUser(mockUser);
                            setLoading(false);
                            return;
                        }

                        onAuthStateChanged(auth, (u) => { 
                            if (u) setUser(u);
                            setLoading(false); 
                        });

                    } catch (err) {
                        console.error("Firebase Init Fatal Error:", err);
                        setUser({ uid: "emergency-local-user" });
                        setAuthWarning("Erro crítico no banco de dados. Modo offline ativado.");
                        setLoading(false);
                    }
                };
                
                setTimeout(initFirebase, 100);
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const { collection, onSnapshot } = window.firebaseModules;

                if (user.uid.startsWith('local-') || user.uid.startsWith('emergency-')) {
                    return;
                }

                try {
                    const unsubIng = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'ingredients'),
                        (snap) => setIngredients(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                        (error) => console.log("Aguardando dados de ingredientes...")
                    );
                    
                    const unsubDish = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'dishes'),
                        (snap) => setDishes(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                        (error) => console.log("Aguardando dados de pratos...")
                    );

                    const unsubSales = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'sales'),
                        (snap) => setSales(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                        (error) => console.log("Aguardando dados de vendas...")
                    );

                    return () => { unsubIng(); unsubDish(); unsubSales(); };
                } catch (err) {
                    console.log("Modo offline ou erro de conexão.");
                }
            }, [user, db, appId]);

            const getIngredient = (id) => ingredients.find(i => i.id === id);
            
            const calculateCost = (components) => {
                if (!components) return 0;
                return components.reduce((acc, comp) => {
                    const ing = getIngredient(comp.ingredientId);
                    if (!ing) return acc;
                    return acc + (ing.price * (comp.quantity || 0));
                }, 0);
            };

            const getDishPrice = (dish, unit) => {
                let val = 0;
                if (unit === 'Geral') {
                    // Average price across all units
                    const prices = UNITS.filter(u => u !== 'Geral').map(u => {
                        return dish.prices && dish.prices[u] ? parseFloat(dish.prices[u]) : parseFloat(dish.salePrice || 0);
                    }).filter(p => !isNaN(p) && p > 0);
                    
                    if (prices.length === 0) return 0;
                    val = prices.reduce((a, b) => a + b, 0) / prices.length;
                } else {
                    if (dish.prices && dish.prices[unit]) val = parseFloat(dish.prices[unit]);
                    else val = parseFloat(dish.salePrice || 0);
                }
                return isNaN(val) ? 0 : val;
            };

            const calculateCMV = (cost, salePrice) => {
                if (!salePrice || salePrice === 0) return 0;
                return (cost / salePrice) * 100;
            };

            const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
            const formatPercent = (val) => new Intl.NumberFormat('pt-BR', { style: 'percent', maximumFractionDigits: 1 }).format(val / 100);

            const getCMVStatus = (cmv) => {
                if (cmv <= 30) return { color: 'text-green-700 bg-green-100', label: 'Ideal' };
                if (cmv <= 40) return { color: 'text-yellow-700 bg-yellow-100', label: 'Atenção' };
                return { color: 'text-red-700 bg-red-100', label: 'Crítico' };
            };

            const parsePTBRNumber = (val) => {
                if (typeof val === 'number') return val;
                if (typeof val === 'string') {
                    const clean = val.replace(/[R$\s]/g, '').replace(',', '.');
                    const num = parseFloat(clean);
                    return isNaN(num) ? 0 : num;
                }
                return 0;
            };

            // --- COMPONENTS ---
            const Dashboard = () => {
                const totalDishes = dishes.length;
                
                const criticalDishesList = dishes.map(d => {
                     const cost = calculateCost(d.components);
                     const price = getDishPrice(d, selectedUnit);
                     const cmv = calculateCMV(cost, price);
                     return { ...d, cost, price, cmv };
                }).filter(d => d.cmv > 40).sort((a, b) => b.cmv - a.cmv);

                const criticalCount = criticalDishesList.length;

                const validDishes = dishes.filter(d => getDishPrice(d, selectedUnit) > 0);
                const avgCMV = validDishes.length > 0 ? validDishes.reduce((acc, d) => {
                    const cost = calculateCost(d.components);
                    return acc + calculateCMV(cost, getDishPrice(d, selectedUnit));
                }, 0) / validDishes.length : 0;

                return (
                    <div className="space-y-8">
                         <div className="bg-indigo-50 border border-indigo-100 p-4 rounded-lg flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <Icon name="MapPin" className="text-indigo-600" />
                                <span className="text-indigo-900 font-medium">Dados exibidos para unidade: <strong>{selectedUnit}</strong></span>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                                <h3 className="text-gray-500 text-sm font-medium">Pratos Cadastrados</h3>
                                <p className="text-3xl font-bold text-gray-800 mt-2">{totalDishes}</p>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                                <h3 className="text-gray-500 text-sm font-medium">Pratos Críticos ({selectedUnit})</h3>
                                <p className={`text-3xl font-bold mt-2 ${criticalCount > 0 ? 'text-red-500' : 'text-green-500'}`}>{criticalCount}</p>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                                <h3 className="text-gray-500 text-sm font-medium">CMV Médio ({selectedUnit})</h3>
                                <p className="text-3xl font-bold text-gray-800 mt-2">{formatPercent(avgCMV)}</p>
                            </div>
                        </div>

                        {criticalCount > 0 && (
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b border-gray-200 bg-red-50 flex items-center justify-between">
                                    <div className="flex items-center space-x-2">
                                        <Icon name="AlertTriangle" className="text-red-500" size={20} />
                                        <h3 className="font-bold text-red-900">Pratos com Lucro Baixo (CMV &gt; 40%)</h3>
                                    </div>
                                    <span className="text-xs text-red-700 bg-red-100 px-2 py-1 rounded-full">Ação Necessária</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prato</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Venda ({selectedUnit})</th>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Custo</th>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">CMV</th>
                                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ação</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {criticalDishesList.map(dish => (
                                                <tr key={dish.id} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{dish.name}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{dish.category || 'Geral'}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">{formatCurrency(dish.price)}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">{formatCurrency(dish.cost)}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-red-700">{dish.cmv.toFixed(1)}%</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-center">
                                                        <button 
                                                            onClick={() => { setSelectedDish(dish); setView('audit'); }}
                                                            className="text-indigo-600 hover:text-indigo-900 font-medium"
                                                        >
                                                            Corrigir
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const OptimizationReport = () => {
                const [checkedItems, setCheckedItems] = useState({});

                // Logic to identify suggestions
                const suggestions = useMemo(() => {
                    if (!dishes.length || !ingredients.length) return [];
                    
                    const list = [];
                    
                    dishes.forEach(dish => {
                        const dishNameUpper = dish.name.toUpperCase();
                        
                        // Classify Dish
                        let type = 'OUTROS';
                        if (dishNameUpper.match(/EXECUTIVO|INDIVIDUAL|PF/)) type = 'EXECUTIVO';
                        else if (dishNameUpper.match(/MEIO|1\/2|2 PESSOAS/)) type = 'MEIO';
                        else if (dishNameUpper.match(/INTEIRO|FAMILIA|3 PESSOAS/)) type = 'INTEIRO';

                        // Check exceptions
                        const isRiceException = dishNameUpper.match(/RISOTO|BAIÃO|BAIAO|ARROZ DE/);

                        if (!dish.components) return;

                        dish.components.forEach(comp => {
                            const ing = ingredients.find(i => i.id === comp.ingredientId);
                            if (!ing) return;
                            
                            const ingNameUpper = ing.name.toUpperCase();
                            const qtyKg = comp.quantity;
                            const qtyG = Math.round(qtyKg * 1000);
                            
                            let newG = qtyG;
                            let reason = '';
                            let rule = '';

                            // Rule 1: Arroz
                            if (ingNameUpper.includes('ARROZ')) {
                                if (isRiceException) {
                                    // Skip or apply 10% logic if critical. Skipping for simplicity as per "Exception" note logic.
                                } else {
                                    if (type === 'EXECUTIVO' && qtyG > 250) { newG = 200; reason = "Adequação ao padrão executivo individual"; rule = "Otimização Arroz"; }
                                    else if (type === 'MEIO' && qtyG > 450) { newG = 400; reason = "Padronização para 2 pessoas"; rule = "Otimização Arroz"; }
                                    else if (type === 'INTEIRO' && qtyG > 750) { newG = 700; reason = "Padronização família/inteiro"; rule = "Otimização Arroz"; }
                                }
                            }

                            // Rule 2: Proteina (Simple Keyword Match)
                            // "Carnes, Frangos, Peixes"
                            if (ingNameUpper.match(/CARNE|FRANGO|PEIXE|FILÉ|FILE|PICANHA|MAMINHA|ALCATRA|LOMBO|BIFE/)) {
                                if (type === 'EXECUTIVO' && qtyG > 200) { newG = 200; reason = "Racionalização de proteína (Padrão Mercado)"; rule = "Racionalização Proteína"; }
                                else if (type === 'MEIO' && qtyG > 500) { newG = 450; reason = "Ajuste de porção média"; rule = "Racionalização Proteína"; }
                                else if (type === 'INTEIRO' && qtyG > 1000) { newG = 900; reason = "Redução de desperdício em grandes porções"; rule = "Racionalização Proteína"; }
                            }

                            // Rule 3: Batata (Perception)
                            if (ingNameUpper.includes('BATATA') && !ingNameUpper.includes('PALHA')) {
                                if (type === 'INTEIRO' && qtyG < 300) { 
                                    newG = 400; 
                                    reason = "Aumento de percepção de valor (Baixo Custo)"; 
                                    rule = "Percepção de Valor"; 
                                }
                            }

                            // Round to nearest 50g
                            if (newG !== qtyG) {
                                newG = Math.round(newG / 50) * 50;
                            }

                            if (newG !== qtyG) {
                                const pricePerKg = ing.price;
                                const oldCost = qtyKg * pricePerKg;
                                const newCost = (newG / 1000) * pricePerKg;
                                const savings = oldCost - newCost;

                                list.push({
                                    id: dish.id + '_' + ing.id,
                                    category: dish.category || 'Geral',
                                    dishName: dish.name,
                                    ingredientName: ing.name,
                                    oldWeight: qtyG,
                                    newWeight: newG,
                                    rule,
                                    reason,
                                    oldCost,
                                    newCost,
                                    savings
                                });
                            }
                        });
                    });

                    // Sort by savings desc
                    return list.sort((a, b) => b.savings - a.savings);
                }, [dishes, ingredients]);

                const toggleItem = (id) => {
                    setCheckedItems(prev => ({ ...prev, [id]: !prev[id] }));
                };

                // Initialize all checked
                useEffect(() => {
                    const initial = {};
                    suggestions.forEach(s => initial[s.id] = true);
                    setCheckedItems(initial);
                }, [suggestions]);

                const totalProjectedSavings = suggestions
                    .filter(s => checkedItems[s.id])
                    .reduce((acc, curr) => acc + curr.savings, 0);

                const copyMarkdown = () => {
                    let md = `## Relatório de Atualização de Custos e Pesos\n\n`;
                    md += `**Economia Estimada Total (por prato vendido): ${formatCurrency(totalProjectedSavings)}**\n\n`;

                    // Group by Category
                    const groups = {};
                    suggestions.forEach(s => {
                        if (!checkedItems[s.id]) return;
                        if (!groups[s.category]) groups[s.category] = [];
                        groups[s.category].push(s);
                    });

                    Object.keys(groups).sort().forEach(cat => {
                        md += `### ${cat}\n`;
                        groups[cat].forEach(s => {
                            md += `\n[x] **${s.dishName}**\n`;
                            md += `- ${s.ingredientName}: De ${s.oldWeight}g para **${s.newWeight}g**\n`;
                            md += `- Motivo: ${s.reason}\n`;
                            md += `- Impacto Custo: De ${formatCurrency(s.oldCost)} para ${formatCurrency(s.newCost)} (Economia: ${formatCurrency(s.savings)})\n`;
                        });
                        md += `\n`;
                    });

                    navigator.clipboard.writeText(md);
                    alert("Relatório em Markdown copiado para a área de transferência!");
                };

                return (
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 className="text-xl font-bold text-gray-800 flex items-center">
                                    <Icon name="Scale" className="mr-2 text-indigo-600" />
                                    Engenharia de Menu (Otimização)
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">Regras aplicadas: Padronização de Arroz, Racionalização de Proteína e Percepção de Valor (Batata).</p>
                            </div>
                            <div className="text-right">
                                <p className="text-xs text-gray-500 uppercase font-semibold">Economia Projetada (Unitária)</p>
                                <p className="text-3xl font-bold text-green-600">{formatCurrency(totalProjectedSavings)}</p>
                            </div>
                        </div>

                        <div className="flex justify-end">
                            <button onClick={copyMarkdown} className="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center hover:bg-gray-900 transition shadow">
                                <Icon name="Clipboard" className="mr-2" size={18} />
                                Copiar Relatório (Markdown)
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            {suggestions.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">
                                    Nenhuma oportunidade de otimização encontrada com as regras atuais.
                                </div>
                            ) : (
                                <div className="divide-y divide-gray-100">
                                    {suggestions.map((s) => (
                                        <div key={s.id} className={`p-4 hover:bg-gray-50 transition flex items-start space-x-4 ${!checkedItems[s.id] ? 'opacity-50' : ''}`}>
                                            <div className="pt-1">
                                                <input 
                                                    type="checkbox" 
                                                    checked={!!checkedItems[s.id]} 
                                                    onChange={() => toggleItem(s.id)}
                                                    className="w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                                />
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between">
                                                    <h3 className="font-bold text-gray-800">{s.dishName} <span className="text-xs font-normal text-gray-500">({s.category})</span></h3>
                                                    <span className={`text-xs px-2 py-1 rounded-full font-semibold ${s.savings > 0 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                                                        {s.rule}
                                                    </span>
                                                </div>
                                                <div className="mt-1 text-sm text-gray-600">
                                                    <span className="font-medium text-gray-900">{s.ingredientName}</span>: 
                                                    De <span className="text-red-600 line-through">{s.oldWeight}g</span> para <span className="font-bold text-green-600">{s.newWeight}g</span>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1 italic">"{s.reason}"</p>
                                            </div>
                                            <div className="text-right w-32">
                                                {s.savings > 0 ? (
                                                    <>
                                                        <p className="text-xs text-gray-400">Economia</p>
                                                        <p className="font-bold text-green-600">{formatCurrency(s.savings)}</p>
                                                    </>
                                                ) : (
                                                    <>
                                                        <p className="text-xs text-gray-400">Investimento</p>
                                                        <p className="font-bold text-blue-600">{formatCurrency(Math.abs(s.savings))}</p>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const Uploader = () => {
                const [logs, setLogs] = useState([]);
                const [isProcessing, setIsProcessing] = useState(false);
                const [uploadComplete, setUploadComplete] = useState(false);

                // Force layout update before blocking logic
                const yieldToMain = () => new Promise(resolve => setTimeout(resolve, 20));

                const addLog = (msg, type = 'info') => {
                    setLogs(prev => [...prev, { msg, type, time: new Date().toLocaleTimeString() }]);
                };

                const clearData = async () => {
                    // Se for modo local/mock, limpa apenas o estado local
                    if (user.uid.startsWith('local-')) {
                        setIngredients([]);
                        setDishes([]);
                        setSales([]);
                        addLog("Dados locais limpos.", "success");
                        return;
                    }

                    const { collection, getDocs, writeBatch } = window.firebaseModules;
                    addLog("Iniciando limpeza da base de dados...", "info");
                    await yieldToMain();
                    
                    try {
                        const deleteCollection = async (path, name) => {
                            const ref = collection(db, 'artifacts', appId, 'users', user.uid, path);
                            const snapshot = await getDocs(ref);
                            if (snapshot.empty) return;
                            
                            addLog(`Apagando ${snapshot.docs.length} itens de ${name}...`, "info");
                            await yieldToMain();

                            const chunk = 300; 
                            for (let i = 0; i < snapshot.docs.length; i += chunk) {
                                const batch = writeBatch(db);
                                snapshot.docs.slice(i, i + chunk).forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                                await yieldToMain(); 
                            }
                        };

                        await Promise.all([
                            deleteCollection('ingredients', 'Ingredientes'),
                            deleteCollection('dishes', 'Pratos'),
                            deleteCollection('sales', 'Vendas')
                        ]);
                        addLog("Base de dados limpa com sucesso.", "success");
                    } catch (e) {
                        addLog("Erro ao limpar dados (verifique permissões do Firebase): " + e.message, "error");
                        console.error(e);
                    }
                };

                const handleFileUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if(!confirm("Tem certeza? Isso apagará TODOS os dados atuais e substituirá pelos novos.")) {
                        e.target.value = null;
                        return;
                    }

                    setIsProcessing(true);
                    setUploadComplete(false);
                    setLogs([{ msg: "Iniciando leitura do arquivo...", type: "info", time: new Date().toLocaleTimeString() }]);
                    
                    setTimeout(async () => {
                        const reader = new FileReader();
                        reader.onload = async (evt) => {
                            try {
                                const data = new Uint8Array(evt.target.result);
                                const wb = XLSX.read(data, { type: 'array' });
                                const { writeBatch, doc, collection } = window.firebaseModules;
                                
                                const ingSheetName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'ingredientes');
                                const dishesSheetName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'pratos');
                                const recipeSheetName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'receitas');
                                const salesSheetName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'vendas');

                                if (!ingSheetName && !dishesSheetName) {
                                    addLog("ERRO: Abas 'Ingredientes' ou 'Pratos' não encontradas.", "error");
                                    setIsProcessing(false);
                                    return;
                                }

                                await clearData();

                                // Se for usuário local, vamos apenas salvar na memória
                                const isLocal = user.uid.startsWith('local-');
                                let localIngredients = [];
                                let localDishes = [];
                                let localSales = [];

                                // Prepara variáveis de Firebase apenas se não for local
                                let batch = isLocal ? null : writeBatch(db);
                                let opCount = 0;
                                
                                const commitBatch = async () => {
                                    if (!isLocal) {
                                        addLog(`Salvando lote de ${opCount} registros...`, "info");
                                        await batch.commit();
                                        await yieldToMain();
                                        batch = writeBatch(db);
                                        opCount = 0;
                                    }
                                };

                                const tempIngMap = new Map();
                                const tempDishMap = new Map();

                                // --- INGREDIENTES ---
                                if (ingSheetName) {
                                    addLog(`Lendo Ingredientes...`, "info");
                                    await yieldToMain();
                                    const ws = wb.Sheets[ingSheetName];
                                    const rows = XLSX.utils.sheet_to_json(ws);
                                    
                                    for (const row of rows) {
                                        const name = row.Nome?.toString().trim();
                                        const price = parsePTBRNumber(row.Preco);
                                        if (!name) continue;
                                        
                                        // Generate ID
                                        const id = isLocal ? 'ing_' + Math.random().toString(36).substr(2, 9) : doc(collection(db, 'artifacts', appId, 'users', user.uid, 'ingredients')).id;
                                        const nameLC = name.toLowerCase();
                                        tempIngMap.set(nameLC, id);
                                        
                                        const data = { id, name, price, unit: row.Unidade || 'kg', lastUpdated: new Date().toISOString() };

                                        if (isLocal) {
                                            localIngredients.push(data);
                                        } else {
                                            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'ingredients', id);
                                            batch.set(ref, data);
                                            opCount++;
                                            if (opCount >= 300) await commitBatch();
                                        }
                                    }
                                }

                                // --- PRATOS ---
                                if (dishesSheetName) {
                                    addLog(`Lendo Pratos...`, "info");
                                    await yieldToMain();
                                    const ws = wb.Sheets[dishesSheetName];
                                    const rows = XLSX.utils.sheet_to_json(ws);
                                    
                                    for (const row of rows) {
                                        const name = row.Nome?.toString().trim();
                                        if (!name) continue;
                                        
                                        const prices = {
                                            'Matriz': parsePTBRNumber(row['Preco Matriz']),
                                            'Mucambo': parsePTBRNumber(row['Preco Mucambo']),
                                            'Frecheirinha': parsePTBRNumber(row['Preco Frecheirinha']),
                                            'Tianguá': parsePTBRNumber(row['Preco Tiangua'])
                                        };

                                        const id = isLocal ? 'dish_' + Math.random().toString(36).substr(2, 9) : doc(collection(db, 'artifacts', appId, 'users', user.uid, 'dishes')).id;
                                        const nameLC = name.toLowerCase();
                                        tempDishMap.set(nameLC, id);
                                        
                                        const data = { 
                                            id,
                                            name, 
                                            category: row.Categoria?.toString().trim() || 'Geral', 
                                            prices, 
                                            components: [], 
                                            createdAt: new Date().toISOString() 
                                        };

                                        if (isLocal) {
                                            localDishes.push(data);
                                        } else {
                                            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'dishes', id);
                                            batch.set(ref, data);
                                            opCount++;
                                            if (opCount >= 300) await commitBatch();
                                        }
                                    }
                                }

                                // --- RECEITAS ---
                                if (recipeSheetName) {
                                    addLog(`Vinculando Receitas...`, "info");
                                    await yieldToMain();
                                    const ws = wb.Sheets[recipeSheetName];
                                    const rawData = XLSX.utils.sheet_to_json(ws);
                                    const recipeGroups = {};

                                    rawData.forEach(row => {
                                        const dName = row.Prato?.toString().trim();
                                        const iName = row.Ingrediente?.toString().trim();
                                        const qtyRaw = row.Quantidade;
                                        if (!dName || !iName || !qtyRaw) return;

                                        const dNameLC = dName.toLowerCase();
                                        if (!recipeGroups[dNameLC]) recipeGroups[dNameLC] = [];
                                        recipeGroups[dNameLC].push({ iName, qtyRaw });
                                    });

                                    let linkedCount = 0;
                                    for (const [dNameLC, comps] of Object.entries(recipeGroups)) {
                                        const dishId = tempDishMap.get(dNameLC);
                                        if (!dishId) continue;

                                        const components = [];
                                        comps.forEach(c => {
                                            const iNameLC = c.iName.toLowerCase();
                                            const ingId = tempIngMap.get(iNameLC);
                                            if (ingId) {
                                                let qty = 0;
                                                const valStr = c.qtyRaw.toString().toLowerCase().replace(',', '.');
                                                if (valStr.endsWith('g') && !valStr.endsWith('kg')) qty = parseFloat(valStr) / 1000;
                                                else if (valStr.endsWith('ml')) qty = parseFloat(valStr) / 1000;
                                                else qty = parseFloat(valStr);

                                                if (!isNaN(qty)) components.push({ ingredientId: ingId, quantity: qty });
                                            }
                                        });

                                        if (components.length > 0) {
                                            if (isLocal) {
                                                const dish = localDishes.find(d => d.id === dishId);
                                                if (dish) dish.components = components;
                                            } else {
                                                const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'dishes', dishId);
                                                batch.update(ref, { components });
                                                opCount++;
                                                if (opCount >= 300) await commitBatch();
                                            }
                                        }
                                        linkedCount++;
                                        if (linkedCount % 50 === 0) await yieldToMain();
                                    }
                                }

                                // --- VENDAS ---
                                if (salesSheetName) {
                                    addLog(`Processando Vendas...`, "info");
                                    await yieldToMain();
                                    const ws = wb.Sheets[salesSheetName];
                                    const rows = XLSX.utils.sheet_to_json(ws);
                                    
                                    for (const row of rows) {
                                        const dishName = row.Prato?.toString().trim();
                                        const qty = parseFloat(row.Quantidade);
                                        const unit = row.Unidade?.toString().trim();
                                        const month = row.Mes?.toString().trim();

                                        if (!dishName || !qty || !unit) continue;
                                        
                                        const data = { 
                                            dishName, 
                                            quantity: qty, 
                                            unit, 
                                            month: month || 'Geral',
                                            timestamp: new Date().toISOString()
                                        };

                                        if (isLocal) {
                                            localSales.push(data);
                                        } else {
                                            const id = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'sales')).id;
                                            const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'sales', id);
                                            batch.set(ref, data);
                                            opCount++;
                                            if (opCount >= 300) await commitBatch();
                                        }
                                    }
                                }
                                
                                if (!isLocal && opCount > 0) await commitBatch();

                                // Update state if local
                                if (isLocal) {
                                    setIngredients(localIngredients);
                                    setDishes(localDishes);
                                    setSales(localSales);
                                    addLog("Dados salvos na memória local (atenção: dados serão perdidos ao recarregar a página).", "success");
                                } else {
                                    addLog("Concluído e salvo no banco de dados!", "success");
                                }
                                
                                setUploadComplete(true);
                            } catch (err) {
                                console.error(err);
                                addLog(`ERRO FATAL: ${err.message}`, "error");
                            } finally {
                                setIsProcessing(false);
                                e.target.value = null;
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }, 500); 
                };

                return (
                    <div className="bg-white p-8 rounded-lg shadow max-w-5xl mx-auto relative">
                        {isProcessing && (
                            <div className="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center rounded-lg">
                                <Icon name="Loader" size={48} className="text-blue-600 mb-4" />
                                <p className="text-xl font-bold text-gray-800">Processando arquivo...</p>
                                <p className="text-sm text-gray-500 mb-4">Por favor, aguarde e não feche a página.</p>
                                <div className="w-full max-w-md bg-gray-100 rounded h-32 overflow-y-auto p-2 border border-gray-300 font-mono text-xs">
                                    {logs.map((log, i) => (
                                        <div key={i} className={`mb-1 ${log.type === 'error' ? 'text-red-600' : 'text-gray-600'}`}>
                                            {log.msg}
                                        </div>
                                    ))}
                                    <div ref={(el) => el && el.scrollIntoView({ behavior: "smooth" })}></div>
                                </div>
                            </div>
                        )}

                        <h2 className="text-2xl font-bold mb-4">Central de Importação</h2>
                        
                        {authWarning && (
                            <div className="bg-orange-50 border border-orange-200 p-4 rounded mb-6 text-sm text-orange-800 flex items-start">
                                <Icon name="AlertTriangle" className="mr-2 flex-shrink-0" />
                                <p><strong>Modo Local:</strong> {authWarning} Os dados carregados agora serão perdidos se você recarregar a página.</p>
                            </div>
                        )}

                        <div className="bg-yellow-50 border border-yellow-200 p-4 rounded mb-6 text-sm text-yellow-800 flex items-start">
                            <Icon name="AlertTriangle" className="mr-2 flex-shrink-0" />
                            <p><strong>Aviso Importante:</strong> Ao enviar uma nova planilha, todos os dados atuais serão apagados e substituídos.</p>
                        </div>

                        {uploadComplete && !isProcessing && (
                            <div className="mb-6 bg-green-50 border border-green-200 p-4 rounded text-green-800 flex items-center justify-between">
                                <span>Importação concluída com sucesso!</span>
                                <div className="space-x-2">
                                    <button onClick={() => setView('dishes')} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold">
                                        Ver Cardápio
                                    </button>
                                    <button onClick={() => setView('sales')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-bold">
                                        Ver Análise de Vendas
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div className="bg-blue-50 p-4 rounded border border-blue-100">
                                <h3 className="font-bold text-blue-800 mb-2">1: "Ingredientes"</h3>
                                <ul className="list-disc list-inside text-xs text-gray-600"><li>Nome</li><li>Preco</li><li>Unidade</li></ul>
                            </div>
                            <div className="bg-indigo-50 p-4 rounded border border-indigo-100">
                                <h3 className="font-bold text-indigo-800 mb-2">2: "Pratos"</h3>
                                <ul className="list-disc list-inside text-xs text-gray-600"><li>Nome</li><li>Categoria</li><li>Preco Matriz...</li></ul>
                            </div>
                            <div className="bg-green-50 p-4 rounded border border-green-100">
                                <h3 className="font-bold text-green-800 mb-2">3: "Receitas"</h3>
                                <ul className="list-disc list-inside text-xs text-gray-600"><li>Prato</li><li>Ingrediente</li><li>Quantidade</li></ul>
                            </div>
                            <div className="bg-purple-50 p-4 rounded border border-purple-100">
                                <h3 className="font-bold text-purple-800 mb-2">4: "Vendas" (Novo)</h3>
                                <ul className="list-disc list-inside text-xs text-gray-600"><li>Prato</li><li>Quantidade</li><li>Unidade</li><li>Mes</li></ul>
                            </div>
                        </div>
                        <div className="flex items-center justify-center w-full">
                            <label className={`flex flex-col items-center justify-center w-full h-32 border-2 border-blue-300 border-dashed rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100 transition ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                    {isProcessing ? <Icon name="Loader" size={32} className="text-blue-500" /> : <Icon name="Upload" className="w-10 h-10 mb-3 text-blue-500" />}
                                    <p className="text-sm text-gray-500">{isProcessing ? 'Aguarde...' : 'Clique para enviar a planilha (.xlsx)'}</p>
                                </div>
                                <input type="file" className="hidden" accept=".xlsx, .xls" onChange={handleFileUpload} disabled={isProcessing} />
                            </label>
                        </div>
                    </div>
                );
            };

            const DishManager = () => {
                const [newDishName, setNewDishName] = useState('');
                const [selectedCategory, setSelectedCategory] = useState('Todas');
                // Sorting State: { key: 'name' | 'price' | 'cost' | 'cmv' | 'profit', direction: 'asc' | 'desc' | null }
                const [sortConfig, setSortConfig] = useState({ key: null, direction: null });
                
                // Sort by category alphabetically
                const categories = useMemo(() => ['Todas', ...Array.from(new Set(dishes.map(d => d.category || 'Geral'))).sort()], [dishes]);
                
                // Process Data for Table
                const processedDishes = useMemo(() => {
                    // 1. Filter
                    let list = selectedCategory === 'Todas' ? dishes : dishes.filter(d => (d.category || 'Geral') === selectedCategory);
                    
                    // 2. Map necessary fields for sorting
                    const mapped = list.map(d => {
                        const cost = calculateCost(d.components);
                        const price = getDishPrice(d, selectedUnit);
                        const cmv = calculateCMV(cost, price);
                        const profit = price - cost;
                        return { ...d, cost, price, cmv, profit };
                    });

                    // 3. Sort
                    if (sortConfig.key) {
                        mapped.sort((a, b) => {
                            if (a[sortConfig.key] < b[sortConfig.key]) {
                                return sortConfig.direction === 'asc' ? -1 : 1;
                            }
                            if (a[sortConfig.key] > b[sortConfig.key]) {
                                return sortConfig.direction === 'asc' ? 1 : -1;
                            }
                            return 0;
                        });
                    } else {
                        // Default sort: Category then Name
                        mapped.sort((a, b) => {
                            const catA = (a.category || 'Geral').toLowerCase();
                            const catB = (b.category || 'Geral').toLowerCase();
                            if (catA < catB) return -1;
                            if (catA > catB) return 1;
                            return a.name.localeCompare(b.name);
                        });
                    }
                    return mapped;
                }, [dishes, selectedCategory, selectedUnit, sortConfig]);

                const requestSort = (key) => {
                    let direction = 'asc';
                    if (sortConfig.key === key) {
                        if (sortConfig.direction === 'asc') direction = 'desc';
                        else if (sortConfig.direction === 'desc') direction = null; // Neutral
                    }
                    setSortConfig({ key: direction ? key : null, direction: direction ? direction : null });
                };

                const getSortIcon = (key) => {
                    if (sortConfig.key !== key) return <div className="w-4 h-4 opacity-0 group-hover:opacity-30 inline-block align-middle ml-1"><Icon name="ArrowUp" size={14}/></div>;
                    if (sortConfig.direction === 'asc') return <div className="w-4 h-4 inline-block align-middle ml-1 text-indigo-600"><Icon name="ArrowUp" size={14}/></div>;
                    return <div className="w-4 h-4 inline-block align-middle ml-1 text-indigo-600"><Icon name="ArrowDown" size={14}/></div>;
                };

                const createDish = async () => {
                    if (!newDishName) return;
                    const { addDoc, collection } = window.firebaseModules;
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'dishes'), {
                        name: newDishName, category: 'Geral', prices: { 'Matriz': 0, 'Mucambo': 0, 'Frecheirinha': 0, 'Tianguá': 0 }, components: [], createdAt: new Date().toISOString()
                    });
                    setNewDishName('');
                };

                const deleteDish = async (id) => { if(confirm('Excluir prato?')) { const { deleteDoc, doc } = window.firebaseModules; await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dishes', id)); }};

                return (
                    <div className="space-y-6">
                        <div className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-sm gap-4">
                            <h2 className="text-xl font-bold text-gray-800">Cardápio ({selectedUnit})</h2>
                            <select className="border rounded px-2 py-2 text-sm bg-gray-50" value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)}>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                            <div className="flex space-x-2 w-full md:w-auto">
                                <input type="text" placeholder="Novo prato..." className="border rounded px-3 py-2 text-sm flex-1" value={newDishName} onChange={(e) => setNewDishName(e.target.value)} />
                                <button onClick={createDish} className="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">+ Adicionar</button>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                             <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th onClick={() => requestSort('category')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group">Categoria {getSortIcon('category')}</th>
                                            <th onClick={() => requestSort('name')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group">Prato {getSortIcon('name')}</th>
                                            <th onClick={() => requestSort('price')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider group">Venda ({selectedUnit}) {getSortIcon('price')}</th>
                                            <th onClick={() => requestSort('cost')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider group">Custo {getSortIcon('cost')}</th>
                                            <th onClick={() => requestSort('cmv')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider group">CMV % {getSortIcon('cmv')}</th>
                                            <th onClick={() => requestSort('profit')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider group">Lucro R$ {getSortIcon('profit')}</th>
                                            <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {processedDishes.map((dish, index) => {
                                            const status = getCMVStatus(dish.cmv);
                                            const hasComponents = dish.components && dish.components.length > 0;

                                            return (
                                                <tr key={dish.id} className="hover:bg-gray-50 transition">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium">{dish.category || 'Geral'}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">{dish.name}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">{formatCurrency(dish.price)}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">{formatCurrency(dish.cost)}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right">
                                                         {hasComponents && dish.price > 0 ? (
                                                            <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${status.color}`}>
                                                                {dish.cmv.toFixed(1)}%
                                                            </span>
                                                         ) : <span className="text-gray-300">--</span>}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right font-medium">
                                                        {formatCurrency(dish.profit)}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <div className="flex justify-center space-x-2">
                                                            <button 
                                                                onClick={() => { setSelectedDish(dish); setView('audit'); }}
                                                                className="text-indigo-600 hover:text-indigo-900 bg-indigo-50 p-1.5 rounded"
                                                                title="Auditar"
                                                            >
                                                                <Icon name="Edit3" size={16} />
                                                            </button>
                                                            <button 
                                                                onClick={() => deleteDish(dish.id)}
                                                                className="text-red-600 hover:text-red-900 bg-red-50 p-1.5 rounded"
                                                                title="Excluir"
                                                            >
                                                                <Icon name="Trash2" size={16} />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const SalesManager = () => {
                const [selectedMonth, setSelectedMonth] = useState('Todos');
                const [selectedCategory, setSelectedCategory] = useState('Todas');
                const [sortConfig, setSortConfig] = useState({ key: 'totalLostProfit', direction: 'desc' });

                // Get Unique Months from Sales Data
                const months = useMemo(() => {
                    const m = new Set(sales.map(s => s.month || 'Geral'));
                    return ['Todos', ...Array.from(m).sort()];
                }, [sales]);

                // Filter Sales by Month and Unit
                const filteredSales = useMemo(() => {
                    return sales.filter(s => {
                        // Check Month
                        if (selectedMonth !== 'Todos' && s.month !== selectedMonth) return false;
                        // Check Unit
                        if (selectedUnit !== 'Geral' && s.unit !== selectedUnit) return false;
                        return true;
                    });
                }, [sales, selectedMonth, selectedUnit]);

                const categoryList = useMemo(() => {
                    const cats = new Set(dishes.map(d => d.category || 'Geral'));
                    return ['Todas', ...Array.from(cats).sort()];
                }, [dishes]);

                // Analyze Data
                const analysis = useMemo(() => {
                    let totalRevenue = 0;
                    let totalCost = 0;
                    let totalPotentialGain = 0; // Opportunity cost if CMV was ideal (e.g. 30%)

                    const details = filteredSales.map(sale => {
                        // Find matching dish to get Cost and Price data
                        const dish = dishes.find(d => d.name.toLowerCase() === sale.dishName.toLowerCase());
                        
                        if (!dish) return null;

                        const dishCategory = dish.category || 'Geral';
                        if (selectedCategory !== 'Todas' && dishCategory !== selectedCategory) return null;

                        const dishPrice = getDishPrice(dish, sale.unit); 
                        const dishCost = calculateCost(dish.components);
                        
                        if (dishPrice <= 0 || dishCost <= 0) return null;

                        const revenue = dishPrice * sale.quantity;
                        const cost = dishCost * sale.quantity;
                        const profit = revenue - cost;
                        const cmv = (dishCost / dishPrice) * 100;

                        const idealCost = dishPrice * 0.30;
                        const lostProfitPerUnit = Math.max(0, dishCost - idealCost);
                        const totalLostProfit = lostProfitPerUnit * sale.quantity;

                        totalRevenue += revenue;
                        totalCost += cost;
                        totalPotentialGain += totalLostProfit;

                        return {
                            ...sale,
                            dish: dish,
                            category: dishCategory,
                            dishPrice,
                            dishCost,
                            revenue,
                            cost,
                            profit,
                            cmv,
                            totalLostProfit
                        };
                    }).filter(Boolean);

                    // Sort Logic for Sales Analysis
                    if (sortConfig.key) {
                        details.sort((a, b) => {
                            if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
                            if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
                            return 0;
                        });
                    }

                    return { details, totalRevenue, totalCost, totalProfit: totalRevenue - totalCost, totalPotentialGain };
                }, [filteredSales, dishes, selectedCategory, sortConfig]);

                const requestSort = (key) => {
                    let direction = 'asc';
                    if (sortConfig.key === key) {
                        if (sortConfig.direction === 'asc') direction = 'desc';
                        else if (sortConfig.direction === 'desc') direction = null; 
                    }
                    setSortConfig({ key: direction ? key : null, direction: direction ? direction : null });
                };

                const getSortIcon = (key) => {
                    if (sortConfig.key !== key) return <div className="w-4 h-4 opacity-0 group-hover:opacity-30 inline-block align-middle ml-1"><Icon name="ArrowUp" size={14}/></div>;
                    if (sortConfig.direction === 'asc') return <div className="w-4 h-4 inline-block align-middle ml-1 text-indigo-600"><Icon name="ArrowUp" size={14}/></div>;
                    return <div className="w-4 h-4 inline-block align-middle ml-1 text-indigo-600"><Icon name="ArrowDown" size={14}/></div>;
                };

                return (
                    <div className="space-y-6">
                        <div className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-sm gap-4">
                            <h2 className="text-xl font-bold text-gray-800">Análise de Vendas ({selectedUnit})</h2>
                            <div className="flex items-center space-x-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-gray-500">Categoria:</span>
                                    <select className="border rounded px-2 py-2 text-sm bg-gray-50" value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)}>{categoryList.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-gray-500">Mês:</span>
                                    <select className="border rounded px-2 py-2 text-sm bg-gray-50" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}>{months.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                </div>
                            </div>
                        </div>

                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                                <p className="text-xs font-semibold text-gray-500 uppercase">Faturamento Real</p>
                                <p className="text-2xl font-bold text-gray-900 mt-1">{formatCurrency(analysis.totalRevenue)}</p>
                            </div>
                            <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                                <p className="text-xs font-semibold text-gray-500 uppercase">Custo Real (Insumos)</p>
                                <p className="text-2xl font-bold text-red-600 mt-1">{formatCurrency(analysis.totalCost)}</p>
                            </div>
                            <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                                <p className="text-xs font-semibold text-gray-500 uppercase">Lucro Real</p>
                                <p className="text-2xl font-bold text-green-600 mt-1">{formatCurrency(analysis.totalProfit)}</p>
                            </div>
                            <div className="bg-yellow-50 p-5 rounded-lg shadow-sm border border-yellow-200 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="TrendingUp" size={48} /></div>
                                <p className="text-xs font-semibold text-yellow-800 uppercase flex items-center">
                                    <Icon name="AlertTriangle" size={12} className="mr-1"/> Oportunidade de Ganho
                                </p>
                                <p className="text-2xl font-bold text-yellow-700 mt-1">{formatCurrency(analysis.totalPotentialGain)}</p>
                                <p className="text-[10px] text-yellow-600 mt-1">Dinheiro "perdido" por CMV acima de 30%</p>
                            </div>
                        </div>

                        {/* Analysis Table */}
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="p-4 border-b border-gray-100 flex justify-between items-center">
                                <h3 className="font-bold text-gray-700">Detalhamento por Prato</h3>
                                <span className="text-xs text-gray-400">Ordenado por padrão por Custo de Oportunidade</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th onClick={() => requestSort('category')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase group">Categoria {getSortIcon('category')}</th>
                                            <th onClick={() => requestSort('dishName')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase group">Prato {getSortIcon('dishName')}</th>
                                            <th onClick={() => requestSort('unit')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase group">Unidade {getSortIcon('unit')}</th>
                                            <th onClick={() => requestSort('quantity')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase group">Qtd {getSortIcon('quantity')}</th>
                                            <th onClick={() => requestSort('revenue')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase group">Faturamento {getSortIcon('revenue')}</th>
                                            <th onClick={() => requestSort('profit')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase group">Lucro Real {getSortIcon('profit')}</th>
                                            <th onClick={() => requestSort('cmv')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase group">CMV Atual {getSortIcon('cmv')}</th>
                                            <th onClick={() => requestSort('totalLostProfit')} className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase text-yellow-700 bg-yellow-50 group">Ganho Potencial {getSortIcon('totalLostProfit')}</th>
                                            <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {analysis.details.map((item, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50 transition">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium">{item.category}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.dishName}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.unit}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{item.quantity}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">{formatCurrency(item.revenue)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 font-medium">{formatCurrency(item.profit)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{item.cmv.toFixed(1)}%</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-yellow-700 bg-yellow-50">
                                                    {item.totalLostProfit > 0 ? `+ ${formatCurrency(item.totalLostProfit)}` : '-'}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                                    <button 
                                                        onClick={() => { setSelectedDish(item.dish); setView('audit'); }}
                                                        className="text-indigo-600 hover:text-indigo-900 bg-indigo-50 p-1.5 rounded"
                                                        title="Auditar Prato"
                                                    >
                                                        <Icon name="Edit3" size={16} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                        {analysis.details.length === 0 && (
                                            <tr>
                                                <td colSpan="9" className="px-6 py-12 text-center text-gray-400">
                                                    Nenhuma venda encontrada para este filtro ou pratos não cadastrados corretamente.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const Auditor = () => {
                if (!selectedDish) return null;
                const [simulatedComponents, setSimulatedComponents] = useState([...selectedDish.components]);
                const initialPrice = getDishPrice(selectedDish, selectedUnit);
                const [simulatedPrice, setSimulatedPrice] = useState(initialPrice);
                const [isDirty, setIsDirty] = useState(false);
                const originalCost = calculateCost(selectedDish.components);
                const simCost = calculateCost(simulatedComponents);
                const simCMV = calculateCMV(simCost, simulatedPrice);
                const status = getCMVStatus(simCMV);

                const handleWeightChange = (index, val) => { 
                    const u = [...simulatedComponents]; 
                    u[index].quantity = val === '' ? '' : parseFloat(val); 
                    setSimulatedComponents(u); 
                    setIsDirty(true); 
                };
                const addIngredient = (e) => { const id = e.target.value; if(!id) return; setSimulatedComponents([...simulatedComponents, { ingredientId: id, quantity: 0 }]); setIsDirty(true); e.target.value = ""; };
                const removeIngredient = (idx) => { setSimulatedComponents(simulatedComponents.filter((_, i) => i !== idx)); setIsDirty(true); };
                const saveChanges = async () => {
                    const { updateDoc, doc } = window.firebaseModules;
                    // If unit is Geral, we can't save a specific price easily without ambiguity.
                    // Let's prevent saving price if Geral is selected or warn user.
                    // For now, let's assume if Geral, we don't update price or update all? 
                    // Best approach: Force user to select a specific unit to audit price.
                    if (selectedUnit === 'Geral') {
                        alert("Por favor, selecione uma unidade específica para salvar alterações de preço.");
                        return;
                    }

                    const updatedPrices = { ...(selectedDish.prices || {}), [selectedUnit]: parseFloat(simulatedPrice) };
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dishes', selectedDish.id), { components: simulatedComponents, prices: updatedPrices });
                    setIsDirty(false); setSelectedDish({ ...selectedDish, components: simulatedComponents, prices: updatedPrices });
                    alert(`Salvo para ${selectedUnit}!`);
                };

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-6 rounded-lg shadow-sm">
                                <div className="flex justify-between items-center mb-6">
                                    <div><h2 className="text-2xl font-bold text-gray-800">Auditoria: {selectedDish.name}</h2><p className="text-sm text-indigo-600 mt-1">Unidade: {selectedUnit}</p></div>
                                    <button onClick={() => setView('dishes')} className="text-gray-500">Voltar</button>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Preço Venda ({selectedUnit})</label>
                                    <input 
                                        type="number" 
                                        className="w-full border rounded p-2 text-lg font-bold text-blue-600 disabled:bg-gray-100 disabled:text-gray-500" 
                                        value={simulatedPrice} 
                                        onChange={(e) => { setSimulatedPrice(e.target.value); setIsDirty(true); }}
                                        disabled={selectedUnit === 'Geral'}
                                    />
                                    {selectedUnit === 'Geral' && <p className="text-xs text-orange-500 mt-1">Selecione uma unidade específica para editar o preço.</p>}
                                </div>
                                <div className="space-y-4">
                                    <h3 className="font-semibold text-gray-700 border-b pb-2">Composição</h3>
                                    {simulatedComponents.map((comp, idx) => {
                                        const ing = getIngredient(comp.ingredientId);
                                        if (!ing) return null;
                                        return (
                                            <div key={idx} className="flex items-center space-x-4 bg-gray-50 p-3 rounded">
                                                <div className="flex-1"><p className="font-medium text-gray-800">{ing.name}</p><p className="text-xs text-gray-500">R$ {ing.price}/{ing.unit}</p></div>
                                                <div className="w-32"><label className="text-xs text-gray-500">Qtd ({ing.unit})</label><input type="number" step="0.001" className="w-full border rounded p-1 text-right" value={comp.quantity} onChange={(e) => handleWeightChange(idx, e.target.value)} /></div>
                                                <div className="w-24 text-right font-medium text-gray-700">{formatCurrency(ing.price * (comp.quantity || 0))}</div>
                                                <button onClick={() => removeIngredient(idx)} className="text-red-400"><Icon name="Trash2" size={16} /></button>
                                            </div>
                                        );
                                    })}
                                    <div className="mt-4 pt-4 border-t border-dashed"><select className="w-full border rounded p-2" onChange={addIngredient} defaultValue=""><option value="" disabled>+ Adicionar Ingrediente</option>{ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}</select></div>
                                </div>
                            </div>
                        </div>
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-lg shadow-lg border border-indigo-100 sticky top-4">
                                <h3 className="text-lg font-bold text-indigo-900 mb-4 flex items-center"><Icon name="Calculator" className="mr-2" />Simulador</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between"><span>Custo Total</span><span className={`font-bold ${simCost < originalCost ? 'text-green-600' : 'text-gray-800'}`}>{formatCurrency(simCost)}</span></div>
                                    <div className="flex justify-between"><span>CMV %</span><span className={`font-bold ${status.color.split(' ')[0]}`}>{simCMV.toFixed(1)}%</span></div>
                                </div>
                                <div className={`mt-6 p-4 rounded text-center ${status.color}`}><p className="text-xs uppercase font-bold">Status</p><p className="text-2xl font-bold">{status.label}</p></div>
                                <div className="mt-6 space-y-2"><button onClick={saveChanges} disabled={!isDirty} className={`w-full py-3 rounded-lg font-bold shadow ${isDirty ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-400'}`}>Salvar</button></div>
                            </div>
                        </div>
                    </div>
                );
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-gray-500">Carregando...</div>;
            if (errorMsg) return (
                <div className="flex flex-col h-screen items-center justify-center text-red-600 p-4 text-center">
                    <Icon name="AlertTriangle" size={48} className="mb-4" />
                    <h2 className="text-xl font-bold mb-2">Erro de Inicialização</h2>
                    <p>{errorMsg}</p>
                    <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Tentar Novamente</button>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white border-b sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center space-x-2 text-indigo-600 cursor-pointer" onClick={() => setView('dashboard')}><Icon name="ChefHat" size={28} /><span className="font-bold text-xl hidden md:inline">Balneário Caratinga</span></div>
                            <div className="flex items-center space-x-2 mx-4"><Icon name="MapPin" size={16} className="text-gray-400" /><select value={selectedUnit} onChange={(e) => setSelectedUnit(e.target.value)} className="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2">{UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                            <nav className="flex space-x-2">
                                <button onClick={() => setView('dashboard')} className={`px-3 py-2 text-sm font-medium ${view === 'dashboard' ? 'text-indigo-600 bg-indigo-50 rounded-md' : 'text-gray-600 hover:text-indigo-600'}`}>Dash</button>
                                <button onClick={() => setView('optimization')} className={`px-3 py-2 text-sm font-medium ${view === 'optimization' ? 'text-indigo-600 bg-indigo-50 rounded-md' : 'text-gray-600 hover:text-indigo-600'}`}>Engenharia</button>
                                <button onClick={() => setView('sales')} className={`px-3 py-2 text-sm font-medium ${view === 'sales' ? 'text-indigo-600 bg-indigo-50 rounded-md' : 'text-gray-600 hover:text-indigo-600'}`}>Análise</button>
                                <button onClick={() => setView('dishes')} className={`px-3 py-2 text-sm font-medium ${view === 'dishes' ? 'text-indigo-600 bg-indigo-50 rounded-md' : 'text-gray-600 hover:text-indigo-600'}`}>Pratos</button>
                                <button onClick={() => setView('upload')} className={`px-3 py-2 text-sm font-medium ${view === 'upload' ? 'text-indigo-600 bg-indigo-50 rounded-md' : 'text-gray-600 hover:text-indigo-600'}`}>Dados</button>
                            </nav>
                        </div>
                    </header>
                    <main className="flex-1 max-w-7xl mx-auto w-full px-4 py-8">{view === 'dashboard' && <Dashboard />}{view === 'optimization' && <OptimizationReport />}{view === 'upload' && <Uploader />}{view === 'dishes' && <DishManager />}{view === 'sales' && <SalesManager />}{view === 'audit' && <Auditor />}</main>
                    <footer className="bg-white border-t mt-auto py-6"><div className="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm"><p>Balneário Caratinga - MG</p></div></footer>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
